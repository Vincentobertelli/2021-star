VERSION 0.5

ARG repository=registry.gitlab.com/xdev-tech/star/frontend

deps:
    FROM node:16-alpine
    WORKDIR /app
    COPY package.json package-lock.json ./
    RUN --mount=type=cache,target=/root/.npm \
        npm ci
    SAVE IMAGE --cache-hint

dev:
    FROM +deps
    COPY ./ ./
    CMD npm start
    ARG ref=
    SAVE IMAGE ${ref}

build:
    FROM +deps
    COPY ./ ./
    RUN npm run build-prod
    SAVE ARTIFACT /app/dist
    SAVE IMAGE --cache-hint

docker:
    FROM nginx:1.19.2-alpine
    COPY nginx.conf /etc/nginx/templates/default.conf.template
    COPY +build/dist/frontend /usr/share/nginx/html
    ARG tag=latest
    ARG ref=${repository}:${tag}
    SAVE IMAGE --push ${ref}
